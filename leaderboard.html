<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2e7d32; /* Green background, consistent with casino theme */
        }
        .leaderboard-item {
            transition: all 0.3s ease-in-out;
        }
        .leaderboard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .rank-badge {
            min-width: 30px; /* Ensure consistent badge width */
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        .rank-1 { background-color: #ffd700; color: #4a3b00; } /* Gold */
        .rank-2 { background-color: #c0c0c0; color: #3e3e3e; } /* Silver */
        .rank-3 { background-color: #cd7f32; color: #5d3a1a; } /* Bronze */
        .rank-other { background-color: #60a5fa; color: white; } /* Blue */

        /* Styles for the message box */
        #message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            font-size: 0.9rem;
        }
        #message-box.success {
            background-color: #28a745; /* Green for success */
            color: white;
        }
        #message-box.error {
            background-color: #dc3545; /* Red for error */
            color: white;
        }
        #message-box.show {
            opacity: 1;
            visibility: visible;
        }

        /* Optional: If you want even more distinct styling for the ad text highlight/link not covered by Tailwind easily */
        /* .ad-text-highlight { color: #FFEB3B; font-weight: bold; } */
        /* .ad-text-link { color: #FFD700; text-decoration: underline; font-weight: bold; } */
        /* .ad-text-link:hover { color: #FFF; } */
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-white shadow-xl rounded-lg p-6 md:p-8">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-8">üèÜ Live Leaderboard üèÜ</h1>

        <div>
            <h2 class="text-2xl font-semibold text-gray-700 mb-6 text-center">Top Winners</h2>
            <div id="leaderboard" class="space-y-3">
                <p class="text-center text-gray-500">Loading leaderboard...</p>
            </div>
        </div>
    </div>
    <div class="w-full max-w-md mt-10 mb-6 text-center">
        <div style="background-color: #60a5fa; border-radius: 5px; margin-bottom: 10px;">Current Liam Coin conversion rate: 1287 Liam Coins = 6.12 Swedish Krona</div>
        <div class="bg-gray-900/90 border-2 border-yellow-500 rounded-lg p-4 shadow-xl">
            <div class="brounded h-24 flex items-center justify-center mb-3">
                <img src="assets/pickled-eggs.png" alt="Pickled Eggs">
                </div>
            <p class="text-gray-200 text-sm md:text-base leading-relaxed">
                üí∞ Big News! Our <span class="font-bold text-yellow-400">Delicious Pickled Eggs</span> just went on sale! üí∞
            </p>
        </div>
    </div>
    <div id="message-box"></div>

    <script>
        const socket = io('http://10.104.160.95:8080'); // Your Socket.IO server
        const leaderboardDiv = document.getElementById('leaderboard');
        const messageBox = document.getElementById('message-box');
        let messageTimeout;
        let currentLocalUser = null; // To store the logged-in user's data from localStorage
        let lastFetchedLeaderboardData = []; // Store the last successfully fetched array

        // Function to show a message (success or error)
        function showMessage(message, type = 'success') {
            messageBox.textContent = message;
            messageBox.className = '';
            messageBox.classList.add(type);
            messageBox.classList.add('show');
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }
            messageTimeout = setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // Function to load local user data from localStorage
        function loadLocalUserData() {
            const userString = localStorage.getItem("user");
            if (userString) {
                try {
                    const parsedUser = JSON.parse(userString);
                    // Ensure username and liamCoins are present and valid
                    if (parsedUser && typeof parsedUser.username === 'string' && parsedUser.liamCoins !== undefined) {
                        const coins = parseInt(parsedUser.liamCoins, 10);
                        if (!isNaN(coins)) {
                            currentLocalUser = {
                                username: parsedUser.username,
                                liamCoins: coins
                                // Include id if you need it for precise matching later
                                // id: parsedUser.id ? parseInt(parsedUser.id, 10) : undefined
                            };
                            console.log("Local user data loaded for leaderboard:", currentLocalUser);
                        } else {
                             currentLocalUser = null; // Parsed liamCoins is NaN
                        }
                    } else {
                        currentLocalUser = null; // Missing username or liamCoins
                    }
                } catch (e) {
                    console.error("Error parsing local user data for leaderboard:", e);
                    currentLocalUser = null;
                }
            } else {
                currentLocalUser = null; // No user in localStorage
            }
        }

        /**
         * Updates the leaderboard display.
         * @param {Array<Object>} usersArray - An array of user objects, e.g., [{username: 'name', liamCoins: 100}, ...]
         * OR an object {username1: score1, username2: score2} for socket updates.
         */
        function updateLeaderboard(data) {
            leaderboardDiv.innerHTML = ''; // Clear previous entries

            let processedUsersArray = [];

            if (Array.isArray(data)) {
                // Data is an array of user objects (likely from HTTP fetch)
                processedUsersArray = data.map(u => ({ ...u })); // Create a shallow copy to make it mutable
            } else if (typeof data === 'object' && data !== null) {
                // Data is an object {username: score} (likely from old socket event or processed form)
                processedUsersArray = Object.entries(data).map(([username, liamCoins]) => ({ username, liamCoins }));
            }


            // If currentLocalUser exists, update their entry in the processedUsersArray or add them
            if (currentLocalUser) {
                const localUserIndex = processedUsersArray.findIndex(u => u.username === currentLocalUser.username);
                if (localUserIndex > -1) {
                    // Update existing user's liamCoins if local is higher or simply to reflect local truth
                    processedUsersArray[localUserIndex].liamCoins = currentLocalUser.liamCoins;
                } else {
                    // Add local user if not in the list (e.g., new user not yet in a full fetch)
                    processedUsersArray.push({ ...currentLocalUser });
                }
            }

            if (processedUsersArray.length === 0) {
                leaderboardDiv.innerHTML = '<p class="text-center text-gray-500">The leaderboard is empty.</p>';
                return;
            }

            // Sort the leaderboard by liamCoins in descending order
            const sortedLeaderboard = processedUsersArray.sort((a, b) => b.liamCoins - a.liamCoins);

            sortedLeaderboard.forEach((user, index) => {
                const rank = index + 1;
                let rankBadgeClass = 'rank-other';
                if (rank === 1) rankBadgeClass = 'rank-1';
                else if (rank === 2) rankBadgeClass = 'rank-2';
                else if (rank === 3) rankBadgeClass = 'rank-3';

                const isCurrentUser = currentLocalUser && user.username === currentLocalUser.username;

                const item = document.createElement('div');
                // Highlight current user
                item.className = `leaderboard-item flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md ${isCurrentUser ? 'ring-2 ring-indigo-500' : ''}`;
                item.innerHTML = `
                    <div class="flex items-center">
                        <span class="rank-badge rounded-full text-xs mr-3 ${rankBadgeClass}">${rank}</span>
                        <span class="font-medium text-gray-700 truncate pr-2 ${isCurrentUser ? 'font-bold' : ''}">${user.username}</span>
                    </div>
                    <span class="font-semibold text-indigo-600 whitespace-nowrap ${isCurrentUser ? 'font-bold' : ''}">${(user.liamCoins || 0).toLocaleString()} Liam Coins</span>
                `;
                leaderboardDiv.appendChild(item);
            });
        }

        // Event listener for when the socket successfully connects
        socket.on('connect', () => {
            console.log('Connected to Socket.IO server!');
            showMessage('Connected to server!', 'success');
            loadLocalUserData();
            fetchLeaderboard(); // Fetch initial data from your Spring Boot API
        });

        // Event listener for leaderboard updates from the Socket.IO server
        socket.on('leaderboard_update', (socketData) => {
            console.log('Leaderboard update received via Socket.IO:', socketData);
            loadLocalUserData(); // Ensure local user info is fresh
            // **IMPORTANT**: You need to decide the format `socketData` will be.
            // If it's already an array of users like from /api/users, great.
            // If it's an object {username: score}, updateLeaderboard can handle it.
            // For consistency, it's best if your Socket.IO server also sends an array of user objects.
            // Or, if the socket only sends updates for *specific* users, you'll need different logic.
            // Assuming for now it might send a full list in a compatible format:
            lastFetchedLeaderboardData = Array.isArray(socketData) ? socketData : Object.entries(socketData).map(([username, liamCoins]) => ({ username, liamCoins }));
            updateLeaderboard(lastFetchedLeaderboardData);
        });

        socket.on('connect_error', (error) => {
            console.error('Connection to Socket.IO server failed:', error);
            leaderboardDiv.innerHTML = '<p class="text-center text-red-500">Could not connect to the leaderboard server.</p>';
            showMessage('Error connecting to Socket.IO server.', 'error');
        });

        // Function to fetch the initial leaderboard state via HTTP from Spring Boot API
        async function fetchLeaderboard() {
            // Replace with your actual Spring Boot API IP and port
            const apiURL = 'http://10.104.160.95:8080/api/users';
            console.log(`Workspaceing leaderboard from ${apiURL}`);
            leaderboardDiv.innerHTML = '<p class="text-center text-gray-500">Loading leaderboard...</p>'; // Show loading state

            try {
                const response = await fetch(apiURL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} from ${apiURL}`);
                }
                const usersArray = await response.json(); // Expecting an array of user objects
                console.log('Initial leaderboard fetched from API:', usersArray);
                lastFetchedLeaderboardData = usersArray; // Store for potential refresh from storage event
                updateLeaderboard(usersArray);
            } catch (error) {
                console.error('Failed to fetch leaderboard from API:', error);
                leaderboardDiv.innerHTML = `<p class="text-center text-red-500">Failed to load leaderboard. Error: ${error.message}. Check API connection.</p>`;
                showMessage('Failed to load leaderboard data.', 'error');
            }
        }

        // Listen for localStorage changes from other tabs
        window.addEventListener('storage', (event) => {
            if (event.key === 'user' && event.newValue) {
                console.log('Leaderboard: Detected "user" change in localStorage.');
                const oldCoins = currentLocalUser ? currentLocalUser.liamCoins : null;
                loadLocalUserData(); // Reload local user data

                // If local user's coins changed, re-render using the last fetched full list + updated local user
                if (currentLocalUser && (currentLocalUser.liamCoins !== oldCoins)) {
                    console.log("Local user's LiamCoins changed, refreshing leaderboard view.");
                    updateLeaderboard(lastFetchedLeaderboardData); // Re-render with stored full list
                }
            }
        });

        // Initial load
        loadLocalUserData();
        // fetchLeaderboard(); // Called on socket 'connect' now
    </script>
</body>
</html>
</body>
</html>