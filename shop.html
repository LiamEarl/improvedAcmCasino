<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Shop - Get Your Upgrades!</title>
    <link rel="stylesheet" href="styles/homepage.css">
    <link rel="stylesheet" href="styles/shop.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="main-container shop-container">

        <div class="shop-header">
            <h1 class="welcome-heading welcome-text">Casino Royale Shop</h1>
            <p class="intro-paragraph">
                Enhance your gameplay! Special offers and exclusive items await.
                <span class="current-chips">Your Liam Coins: <span id="player-chip-balance">0</span> 🪙</span>
            </p>
            <a href="index.html" class="casino-btn back-to-casino-btn">← Back to Casino</a>
        </div>

        <h2 class="game-choice-heading shop-section-heading">Featured Items</h2>

        <div class="shop-items-grid">
            <div class="shop-item" id="item-stash-10k">
                <div class="item-image-placeholder">
                    <img src="assets/chip_bundle_large.png" alt="Large Chip Bundle">
                </div>
                <h3 class="item-name">High Roller's Stash</h3>
                <p class="item-description">Get a massive boost with 10,000 Liam Coins!</p>
                <div class="item-price">
                    <span class="price-value">10,000</span> <span class="currency-icon">🪙</span>
                </div>
                <button type="button" class="casino-btn buy-btn primary-action-btn" data-item-id="stash_10k" data-price="10000" data-currency="chips" data-item-name="High Roller's Stash" data-item-type="chips" data-chip-amount="10000">Buy Now</button>
                <span class="item-tag popular-tag">🔥 Popular!</span>
            </div>

            <div class="shop-item" id="item-gold-card">
                <div class="item-image-placeholder">
                     <img src="assets/gold_card_skin.png" alt="Gold Card Skin">
                </div>
                <h3 class="item-name">Golden Card Back</h3>
                <p class="item-description">Show off your style with this exclusive card skin.</p>
                <div class="item-price">
                    <span class="price-value">2,500</span> <span class="currency-icon">🪙</span>
                </div>
                <button type="button" class="casino-btn buy-btn" data-item-id="gold_card" data-price="2500" data-currency="chips" data-item-name="Golden Card Back" data-item-type="skin">Get Item</button>
            </div>

            <div class="shop-item limited-offer" id="item-mystery-box">
                <div class="item-image-placeholder">
                    <img src="assets/mystery_box.png" alt="Mystery Box">
                </div>
                <h3 class="item-name">Mystery Box <span class="timer-text" id="mystery-box-timer">(10:00)</span></h3>
                <p class="item-description">Contains a random rare item or a huge Liam Coin prize!</p>
                <div class="item-price">
                    <span class="price-value original-price">1,500</span>
                    <span class="price-value sale-price">1,000</span> <span class="currency-icon">🪙</span>
                </div>
                <button type="button" class="casino-btn buy-btn primary-action-btn" data-item-id="mystery_box" data-price="1000" data-currency="chips" data-item-name="Mystery Box" data-item-type="lootbox">Snag Deal!</button>
                <span class="item-tag limited-tag">⏳ Limited Time!</span>
            </div>

            <div class="shop-item" id="item-starter-pack">
                <div class="item-image-placeholder">
                    <img src="assets/chip_bundle_small.png" alt="Small Chip Bundle">
                </div>
                <h3 class="item-name">Starter Pack</h3>
                <p class="item-description">A quick top-up of 500 Liam Coins.</p>
                <div class="item-price">
                    <span class="price-value">500</span> <span class="currency-icon">🪙</span>
                </div>
                <button type="button" class="casino-btn buy-btn" data-item-id="starter_pack" data-price="500" data-currency="chips" data-item-name="Starter Pack" data-item-type="chips" data-chip-amount="500">Add Chips</button>
            </div>
        </div>

        <h2 class="game-choice-heading shop-section-heading">Special Bundles</h2>
        <div class="shop-items-grid">
            <div class="shop-item" id="item-vip-pass">
                <div class="item-image-placeholder">
                     <img src="assets/vip_pass.png" alt="VIP Pass">
                </div>
                <h3 class="item-name">VIP Monthly Pass</h3>
                <p class="item-description">Daily chip bonuses, exclusive tables, and more!</p>
                <div class="item-price">
                     <span class="price-value">$19.99/month</span> </div>
                <button type="button" class="casino-btn buy-btn primary-action-btn best-value-btn" data-item-id="vip_pass" data-price="19.99" data-currency="usd" data-item-name="VIP Monthly Pass" data-item-type="subscription">Become VIP</button>
                 <span class="item-tag best-value-tag">💎 Best Value!</span>
            </div>
        </div>
    </div>
    <div style="color: white; font-size: 10px;">DISCLAIMER: Shop does not actually do anything. Spend Liam Coins at your own risk.</div>
    <div class="footer" style="background-color: lightblue; border-radius: 5px;">Rocket League 2025</div>
    

    <script>
        // --- Global State & Configuration ---
        const chipBalanceElement = document.getElementById('player-chip-balance');
        const MYSTERY_BOX_DURATION_SECONDS = 10 * 60; // 10 minutes for the timer

        // --- Load User Data ---
        const user = JSON.parse(localStorage.getItem("user"));
        let id;
        let liamCoins; // This will be our primary currency variable for the shop

        if (!user || user.id === undefined || user.liamCoins === undefined) {
            // If user data is missing or incomplete, redirect to login
            // You might want to handle this more gracefully, e.g., show a message
            console.error("User data not found or incomplete in localStorage. Redirecting to login.");
            window.location.href = "games/login.html";
        } else {
            id = parseInt(user.id, 10);
            liamCoins = parseInt(user.liamCoins, 10);

            if (isNaN(id) || isNaN(liamCoins)) {
                console.error("User ID or LiamCoins is not a valid number after parsing. Redirecting to login.");
                window.location.href = "games/login.html";
            }
        }

        // --- Utility Functions ---
        function formatChipCount(coins) {
            return coins.toLocaleString(); // Adds commas for thousands
        }

        function updateLiamCoinDisplayAndStorage() {
            if (chipBalanceElement) {
                chipBalanceElement.textContent = formatChipCount(liamCoins);
            }
            // Update the user object in memory
            if (user) { // Ensure user object exists
                user.liamCoins = liamCoins.toString();
                // Save updated user object back to localStorage
                localStorage.setItem("user", JSON.stringify(user)); // Stringify before saving
            }


            // Persist to backend API
            if (user && id !== undefined) { // Ensure we have a user and ID
                fetch(`http://10.104.160.95:8080/api/users/${id}`, { // Use template literal for clarity
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(user) // Send the whole user object
                })
                .then(response => {
                    if (!response.ok) {
                        // If response is not OK, throw an error to be caught by .catch
                        return response.text().then(text => { throw new Error(`Network response was not ok: ${response.status} ${response.statusText} - ${text}`) });
                    }
                    return response.json();
                })
                .then(data => console.log('Shop: Updated user on backend:', data))
                .catch(error => console.error('Shop: Error updating user on backend:', error));
            }
        }


        function showNotification(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            alert(message); // Simple alert for now
        }

        // --- Initialization ---
        function initializeShop() {
            if (isNaN(liamCoins)) { // Double check after potential redirection
                // This case should ideally be caught by the initial check,
                // but as a safeguard if initializeShop is called unexpectedly.
                console.error("LiamCoins is NaN during shop initialization. This shouldn't happen.");
                return; // Prevent further execution if liamCoins is not valid
            }
            updateLiamCoinDisplayAndStorage(); // Initial display and ensure localStorage is current
            startMysteryBoxTimer(MYSTERY_BOX_DURATION_SECONDS);
            setupEventListeners();
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.querySelectorAll('.buy-btn').forEach(button => {
                button.addEventListener('click', handlePurchaseAttempt);
            });
        }

        // --- Purchase Logic ---
        function handlePurchaseAttempt(event) {
            const button = event.currentTarget;
            const itemId = button.dataset.itemId;
            const itemName = button.dataset.itemName;
            const price = parseFloat(button.dataset.price);
            const currency = button.dataset.currency;
            const itemType = button.dataset.itemType;
            const chipAmount = parseInt(button.dataset.chipAmount, 10) || 0;

            console.log(`Attempting purchase: ${itemName} (ID: ${itemId}) for ${price} ${currency}`);

            if (currency === 'chips') { // Assuming 'chips' means LiamCoins
                if (liamCoins >= price) {
                    liamCoins -= price;
                    if (itemType === 'chips') { // If the item itself is a bundle of LiamCoins
                        liamCoins += chipAmount;
                    }

                    updateLiamCoinDisplayAndStorage(); // This will update display, localStorage, and backend
                    showNotification(`Successfully purchased ${itemName}!`, 'success');
                    // TODO: Add item to player's inventory (client-side representation or backend call if it's not just currency)
                    console.log(`SHOP: Purchase successful. User ${id} bought ${itemName}. Current LiamCoins: ${liamCoins}`);

                } else {
                    showNotification('Not enough LiamCoins for this item!', 'error');
                }
            } else if (currency === 'usd') {
                showNotification(`Initiating purchase for ${itemName} for $${price}. \nRedirecting to payment provider... (simulation)`, 'info');
                console.log(`BACKEND CALL SIMULATION: createPaymentIntent(user, ${itemId}, ${price} USD)`);
            } else {
                showNotification('Unknown currency type.', 'error');
            }
        }

        // --- Mystery Box Timer ---
        let mysteryBoxInterval;
        function startMysteryBoxTimer(durationSeconds) {
            const timerElement = document.getElementById('mystery-box-timer');
            if (!timerElement) return;

            let timeLeft = durationSeconds;

            if (mysteryBoxInterval) {
                clearInterval(mysteryBoxInterval);
            }

            mysteryBoxInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(mysteryBoxInterval);
                    timerElement.textContent = "(Expired!)";
                    const mysteryBoxButton = document.querySelector('button[data-item-id="mystery_box"]');
                    if (mysteryBoxButton) {
                        mysteryBoxButton.disabled = true;
                        mysteryBoxButton.textContent = "Deal Expired";
                    }
                } else {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = `(${minutes}:${seconds < 10 ? '0' : ''}${seconds})`;
                    timeLeft--;
                }
            }, 1000);
        }

        // --- Document Ready ---
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeShop);
        } else {
            // DOMContentLoaded has already fired only if user was not redirected
            if (user && !isNaN(liamCoins)) { // Check if user data is valid before initializing
                 initializeShop();
            }
        }

    </script>
</body>
</html>